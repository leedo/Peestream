? my $app = shift;
<html>
  <head>
    <style type="text/css">
      body {
        font-family: Helvetica, Arial, sans-serif;
      }
      p {
        margin: 0;
        padding-bottom: 5px;
      }
      textarea {
        width: 100%;
        height: 60px;
        border: 1px solid #ccc;
      }
      table#controls th {
        text-align: left;
      }
      table#messages td.info {
        position: relative;
        width: 100px;
        background: #efefef;
        border-bottom: 1px solid #ccc;
      }
      table#messages td {
        border-bottom: 1px solid #eee;
        vertical-align: top;
        padding: 5px 10px;
      }
      table#messages {
        width: 100%;
        border: 1px solid #ccc;
        border-bottom: none;
        border-left: none;
      }
      span.author {
        font-weight: bold;
      }
      span.time {
        color: #999;
        font-size: 0.7em;
      }
    </style>
    <script type="text/javascript" src="/static/prototype.js"></script>
    <script type="text/javascript">
      var shifting = false;
      document.observe("dom:loaded", function() {
        $('msg_text').focus();
        var submitMessage = function(e) {
          e.stop();
          new Ajax.Request("/post", {
            method: 'post',
            parameters: $('message').serialize(),
            onSuccess: function(transport) {
              $('msg_text').value = '';
              $('msg_text').focus();
            }
          });
        };
        $('message').observe('submit', submitMessage);
        $('msg_text').observe('keydown', function (e) {
          if (! shifting && e.keyCode == "13") {
            console.log(shifting);
            e.stop();
            submitMessage(e);
          }
        });
        document.observe('keydown', function (e) {
          if (e.keyCode == 16) shifting = true;
        });
        document.observe('keyup', function(e) {
          if (e.keyCode == 16) shifting = false;
        });
        setTimeout(function () {
          var len = 0;
          var seperator = "--xpeestreamx\n";
          new Ajax.Request("/stream", {
            method: 'get',
            onInteractive: function(transport) {
              var data = transport.responseText.slice(len);
              var start, end;
              start = data.indexOf(seperator);
              if (start > -1) {
                start += seperator.length;
                end = data.indexOf(seperator, start);
                if (end == -1) return;
              }
              else return;
              len += (end + seperator.length) - start;
              data = data.slice(start, end);
              try {
                data = data.evalJSON();
                data.each(function(item) {
                  $('messages').insert({top: item});
                });
              }
              catch (e) {
              }
            },
            onSuccess: function(transport) {
            },
            onFailure: function(transport) {
            }
          });
        }, 1000);
      });
    </script>
  </head>
  <body>
    <form id="message" method="post" action="/post">
      <table width="100%" id="controls">
        <thead>
          <tr>
            <th>Message</th>
            <th>Images</th>
          </tr>
        </thead>
        <tr>
          <td width="50%">
            <textarea name="msg" id="msg_text" tabindex="1"></textarea>
          </td>
          <td valign="top">
            <input type="file" name="image" id="image1" />
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <input type="submit" value="Post message" tabindex="2" />
            <span style="color:#999;font-size:0.7em">as</span> <input type="text" name="author" />
          </td>
        </tr>
      </table>
    </form>
    <table id="messages" cellspacing="0" cellpadding="0">
    <? for (reverse @{$app->messages}) { ?>
      <?= $_ ?>
    <? } ?>
    </table>
  </body>
</html>
